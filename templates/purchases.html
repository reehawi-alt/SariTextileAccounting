{% extends "base.html" %}

{% block title %}Purchases - SARI TEXTILE WAREHOUSES ACCOUNTING{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Purchases</h1>
    <div class="action-buttons">
        <button class="btn btn-secondary" onclick="exportPurchases()">ðŸ“Š Export to Excel</button>
        <button class="btn btn-secondary" onclick="openImportModal()">Import from Excel</button>
        <button class="btn btn-primary" onclick="openAddContainerModal()">+ Add Container</button>
    </div>
</div>

<!-- Counts -->
<div class="filters" style="margin-top: 10px; margin-bottom: 15px;">
    <div class="filters-row">
        <div class="form-group">
            <label>Total Purchases</label>
            <div id="totalPurchasesCount" style="font-weight: 700; font-size: 16px;">0</div>
        </div>
    </div>
</div>

<div class="table-container">
    <table id="purchasesTable">
        <thead>
            <tr>
                <th class="sortable">Container No</th>
                <th class="sortable">Date</th>
                <th class="sortable">Supplier</th>
                <th class="sortable">Currency</th>
                <th class="sortable">Exchange Rate</th>
                <th class="sortable">Total Amount</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="purchasesTableBody">
            <tr><td colspan="7" class="empty-state">Loading...</td></tr>
        </tbody>
    </table>
</div>

<!-- Add/Edit Container Modal -->
<div id="containerModal" class="modal">
    <div class="modal-content" style="max-width: 900px;" id="containerModalContent">
        <div class="modal-header-draggable" id="containerModalHeader">
            <h2 id="containerModalTitle" style="margin: 0;">Add Container</h2>
            <span class="close" onclick="closeContainerModal(event)">&times;</span>
        </div>
        <form id="containerForm" style="max-height: 80vh; overflow-y: auto; padding-right: 6px;">
            <input type="hidden" id="containerId">
            <div class="form-row">
                <div class="form-group">
                    <label>Container Number *</label>
                    <input type="text" id="containerNumber" required>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="containerDate" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Supplier *</label>
                    <select id="containerSupplier" required>
                        <option value="">Select Supplier</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Currency *</label>
                        <input type="text" id="containerCurrency" required>
                    </div>
                    <div class="form-group">
                        <label>Exchange Rate *</label>
                        <input type="number" id="containerExchangeRate" step="0.0001" required>
                    </div>
                </div>
            </div>
            <div class="form-group" style="max-height: 50vh; overflow-y: auto; padding-right: 6px;">
                <label>Items *</label>
                <div id="containerItems">
                    <div class="container-item-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px;">
                        <select class="item-select" required>
                            <option value="">Select Item</option>
                        </select>
                        <input type="number" class="item-quantity" placeholder="Qty" step="0.01" required>
                        <input type="number" class="item-price" placeholder="Unit Price" step="0.01" required>
                        <input type="text" class="item-weight" placeholder="Unit Weight" readonly>
                        <input type="text" class="item-total-weight" placeholder="Total Weight" readonly>
                        <input type="text" class="item-total" placeholder="Total" readonly>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeContainerItemRow(this)">Ã—</button>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addContainerItemRow()">+ Add Item</button>
            </div>
            <div class="form-group">
                <label>Total Amount</label>
                <input type="text" id="containerTotal" readonly style="font-size: 18px; font-weight: 600;">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                <div class="form-group">
                    <label style="font-weight: 600; color: #1e3a5f;">Total Item Units</label>
                    <input type="text" id="containerTotalUnits" readonly style="font-size: 16px; font-weight: 600; background-color: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label style="font-weight: 600; color: #1e3a5f;">Total Weight</label>
                    <input type="text" id="containerTotalWeight" readonly style="font-size: 16px; font-weight: 600; background-color: #f5f5f5;">
                </div>
            </div>
            
            <!-- Expenses Section -->
            <div style="border-top: 2px solid #e0e0e0; padding-top: 20px; margin-top: 20px;">
                <h3 style="margin-bottom: 15px; color: #1e3a5f;">Expenses</h3>
                
                <!-- Expense 1 (Supplier Expense) -->
                <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; margin-bottom: 10px; color: #666;">Expense 1 (Supplier Expense - Added to Supplier Debit)</h4>
                    <div style="margin-bottom: 8px; font-size: 12px; color: #666; font-style: italic;">Currency and exchange rate automatically match container currency</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" id="expense1Amount" step="0.01" value="0">
                        </div>
                    </div>
                </div>
                
                <!-- Expense 2 (Service Company Expense) -->
                <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; margin-bottom: 10px; color: #666;">Expense 2 (Service Company Expense - Added to Service Company Debit)</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Service Company</label>
                            <select id="expense2ServiceCompany">
                                <option value="">Select Service Company</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" id="expense2Amount" step="0.01" value="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Currency</label>
                            <input type="text" id="expense2Currency" placeholder="Same as container">
                        </div>
                        <div class="form-group">
                            <label>Exchange Rate</label>
                            <input type="number" id="expense2ExchangeRate" step="0.0001" placeholder="Same as container">
                        </div>
                    </div>
                </div>
                
                <!-- Expense 3 (Cash Expense) -->
                <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; margin-bottom: 10px; color: #666;">Expense 3 (Cash Expense - Shown in Safe Movement)</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" id="expense3Amount" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Currency</label>
                            <input type="text" id="expense3Currency" placeholder="Same as container">
                        </div>
                        <div class="form-group">
                            <label>Exchange Rate</label>
                            <input type="number" id="expense3ExchangeRate" step="0.0001" placeholder="Same as container">
                        </div>
                    </div>
                </div>
                
                <!-- Total Expenses Box -->
                <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin-top: 15px; border: 2px solid #2196f3;">
                    <label style="font-weight: 600; color: #1976d2; font-size: 16px;">Total Expenses (1+2+3)</label>
                    <input type="text" id="totalExpenses" readonly style="font-size: 18px; font-weight: 700; color: #1976d2; background-color: #fff; border: 1px solid #2196f3;">
                </div>
            </div>
            
            <div class="form-group">
                <label>Notes</label>
                <textarea id="containerNotes" rows="3"></textarea>
            </div>
            <div class="action-buttons">
                <button type="submit" class="btn btn-primary">Save Container</button>
                <button type="button" class="btn btn-secondary" onclick="closeContainerModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeImportModal()">&times;</span>
        <h2>Import Purchases from Excel</h2>
        <p style="color:#666;margin-bottom:10px;">Required columns: ContainerNumber, Date, Supplier, Currency, ExchangeRate, ItemCode, Quantity, UnitPrice (optional: Notes)</p>
        <form id="importPurchasesForm" enctype="multipart/form-data">
            <div class="form-group">
                <label>Excel File *</label>
                <input type="file" id="purchasesExcelFile" accept=".xlsx,.xls" required>
            </div>
            <div class="action-buttons">
                <button type="submit" class="btn btn-primary">Import</button>
                <button type="button" class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script src="{{ url_for('static', filename='js/purchases.js') }}"></script>
{% endblock %}
