{% extends "base.html" %}

{% block title %}Payments - SARI TEXTILE WAREHOUSES ACCOUNTING{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Payments</h1>
    <div class="action-buttons">
        <button class="btn btn-secondary" onclick="exportPayments()">ðŸ“Š Export to Excel</button>
        <button class="btn btn-secondary" onclick="openImportModal()">Import from Excel</button>
        <button class="btn btn-primary" onclick="openAddPaymentModal()">+ Add Payment</button>
    </div>
</div>

<!-- Filters -->
<div class="filters" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <div class="filters-row" style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
        <div class="form-group" style="flex: 1; min-width: 200px;">
            <label>Company</label>
            <select id="filterCompany" class="form-control" onchange="loadPayments()">
                <option value="">All Companies</option>
            </select>
        </div>
        <div class="form-group">
            <button class="btn btn-secondary" onclick="clearPaymentFilters()">Clear Filters</button>
        </div>
    </div>
</div>

<div class="table-container">
    <table id="paymentsTable">
        <thead>
            <tr>
                <th class="sortable">Date</th>
                <th>Company</th>
                <th>Type</th>
                <th class="sortable">Amount</th>
                <th>Currency</th>
                <th class="sortable">Base Currency Amount</th>
                <th>Exchange Rate</th>
                <th>Invoice</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="paymentsTableBody">
            <tr><td colspan="9" class="empty-state">Loading...</td></tr>
        </tbody>
    </table>
</div>

<!-- Add/Edit Payment Modal -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closePaymentModal()">&times;</span>
        <h2 id="paymentModalTitle">Add Payment</h2>
        <form id="paymentForm">
            <input type="hidden" id="paymentId">
            <div class="form-row">
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="paymentDate" required>
                </div>
                <div class="form-group">
                    <label>Company *</label>
                    <select id="paymentCompany" required>
                        <option value="">Select Company</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Payment Type *</label>
                    <select id="paymentType" required>
                        <option value="">Select Type</option>
                        <option value="In">In (Money Received)</option>
                        <option value="Out">Out (Money Paid Out)</option>
                    </select>
                    <small style="color: #666;">For customers: In = payment received, Out = refund/return. For suppliers: Out = payment made.</small>
                </div>
                <div class="form-group">
                    <label>Invoice Number (Optional)</label>
                    <input type="text" id="paymentInvoice">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Currency *</label>
                    <input type="text" id="paymentCurrency" required>
                    <small style="color: #666;">Original currency (for company statement)</small>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Amount (Original Currency) *</label>
                    <input type="number" id="paymentAmount" step="0.01" required>
                    <small style="color: #666;">Amount in original currency (shown in company statement)</small>
                </div>
                <div class="form-group">
                    <label>Amount (Base Currency) *</label>
                    <input type="number" id="paymentAmountBase" step="0.01" required>
                    <small style="color: #666;">Amount in base currency (for safe movements)</small>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Exchange Rate (Calculated)</label>
                    <input type="number" id="paymentExchangeRate" step="0.0001" readonly style="background: #f5f5f5;">
                    <small style="color: #666;">Automatically calculated: Base Amount Ã· Original Amount</small>
                </div>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="paymentNotes" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="paymentLoan" style="width: auto;">
                    <span>This is a loan/borrowing transaction</span>
                </label>
                <small style="color: #666;">Check this if you borrowed money from the supplier/service company (not a payment for goods/services)</small>
            </div>
            <div class="action-buttons">
                <button type="submit" class="btn btn-primary">Save Payment</button>
                <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeImportModal()">&times;</span>
        <h2>Import Payments from Excel</h2>
        <p style="color:#666;margin-bottom:10px;">Required columns: Date, Company, PaymentType (In/Out), Amount, Currency, AmountBaseCurrency<br>Optional: InvoiceNumber, Notes<br><small style="color:#999;">Note: AmountBaseCurrency is the amount in base currency. ExchangeRate column is also supported for backward compatibility.</small></p>
        <form id="importPaymentsForm" enctype="multipart/form-data">
            <div class="form-group">
                <label>Excel File *</label>
                <input type="file" id="paymentsExcelFile" accept=".xlsx,.xls" required>
            </div>
            <div class="action-buttons">
                <button type="submit" class="btn btn-primary">Import</button>
                <button type="button" class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script src="{{ url_for('static', filename='js/payments.js') }}"></script>
{% endblock %}
