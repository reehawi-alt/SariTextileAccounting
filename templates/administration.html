{% extends "base.html" %}

{% block title %}Administration - SARI TEXTILE WAREHOUSES ACCOUNTING{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Administration</h1>
</div>

<!-- Navigation Buttons -->
<div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
    <button id="safeAdjustmentsBtn" class="btn btn-primary" onclick="showSection('safe')" style="padding: 12px 24px; font-size: 16px; font-weight: 600;">
        üí∞ Safe Adjustments
    </button>
    <button id="inventoryAdjustmentsBtn" class="btn btn-secondary" onclick="showSection('inventory')" style="padding: 12px 24px; font-size: 16px; font-weight: 600;">
        üì¶ Inventory Quantity Adjustments
    </button>
    <button id="physicalCountBtn" class="btn btn-secondary" onclick="showSection('physical-count')" style="padding: 12px 24px; font-size: 16px; font-weight: 600;">
        üìã Physical Inventory Count
    </button>
    <button id="importDataBtnTab" class="btn btn-secondary" onclick="showSection('import-data')" style="padding: 12px 24px; font-size: 16px; font-weight: 600;">
        üì• Import Data
    </button>
    <button id="otherSettingsBtn" class="btn btn-secondary" onclick="showSection('other')" style="padding: 12px 24px; font-size: 16px; font-weight: 600;">
        ‚öôÔ∏è Other Settings
    </button>
</div>

<!-- Safe Adjustments Section -->
<div id="safeAdjustmentsSection" style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h2 style="margin-bottom: 20px; color: #1e3a5f;">Safe Adjustments</h2>
    <p style="color: #666; margin-bottom: 20px;">Add manual adjustment transactions (inflow or outflow) that are not tied to sales, payments, or expenses.</p>
    
    <form id="adjustmentForm" style="max-width: 600px; margin-bottom: 30px;">
        <input type="hidden" id="adjustmentId" value="">
        <h3 id="adjustmentFormTitle" style="margin-bottom: 15px; color: #1e3a5f;">Add New Adjustment</h3>
        <div class="form-row">
            <div class="form-group">
                <label>Transaction Type *</label>
                <select id="adjustmentType" required class="form-control">
                    <option value="">Select Type</option>
                    <option value="Inflow">Inflow (Money In)</option>
                    <option value="Outflow">Outflow (Money Out)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date *</label>
                <input type="date" id="adjustmentDate" required class="form-control">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" id="adjustmentAmount" step="0.01" required class="form-control" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>Currency *</label>
                <input type="text" id="adjustmentCurrency" required class="form-control" value="CFA">
            </div>
            <div class="form-group">
                <label>Exchange Rate *</label>
                <input type="number" id="adjustmentExchangeRate" step="0.0001" required class="form-control" value="1" placeholder="1.0000">
            </div>
        </div>
        
        <div class="form-group">
            <label>Description *</label>
            <input type="text" id="adjustmentDescription" required class="form-control" placeholder="e.g., Manual adjustment, Safe balancing, etc.">
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary" id="adjustmentSubmitBtn">Add Adjustment</button>
            <button type="button" class="btn btn-secondary" onclick="clearAdjustmentForm()">Clear</button>
            <button type="button" class="btn btn-secondary" id="adjustmentCancelBtn" onclick="clearAdjustmentForm()" style="display: none;">Cancel</button>
        </div>
    </form>
    
    <div id="adjustmentMessage" style="margin-top: 20px;"></div>
    
    <h3 style="margin-top: 30px; margin-bottom: 15px; color: #1e3a5f;">Existing Adjustments</h3>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Currency</th>
                    <th>Balance After</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="adjustmentsTableBody">
                <tr>
                    <td colspan="7" class="empty-state">Loading adjustments...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Inventory Quantity Adjustments Section -->
<div id="inventoryAdjustmentsSection" style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin-bottom: 10px; color: #1e3a5f;">Inventory Quantity Adjustments</h2>
            <p style="color: #666; margin: 0;">Adjust inventory quantities without affecting COG calculations or financial reports. Use this for corrections, write-offs, or found stock.</p>
        </div>
        <button class="btn btn-secondary" onclick="openInventoryImportModal()" style="padding: 10px 20px;">
            üìä Import from Excel
        </button>
    </div>
    
    <form id="inventoryAdjustmentForm" style="max-width: 600px; margin-bottom: 30px;">
        <input type="hidden" id="inventoryAdjustmentId" value="">
        <h3 id="inventoryAdjustmentFormTitle" style="margin-bottom: 15px; color: #1e3a5f;">Add New Adjustment</h3>
        <div class="form-row">
            <div class="form-group">
                <label>Item *</label>
                <select id="inventoryAdjustmentItem" required class="form-control">
                    <option value="">Select Item</option>
                </select>
            </div>
            <div class="form-group">
                <label>Adjustment Type *</label>
                <select id="inventoryAdjustmentType" required class="form-control">
                    <option value="">Select Type</option>
                    <option value="Increase">Increase (Add Stock)</option>
                    <option value="Decrease">Decrease (Remove Stock)</option>
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>Quantity *</label>
                <input type="number" id="inventoryAdjustmentQuantity" step="0.01" required class="form-control" placeholder="0.00" min="0.01">
            </div>
            <div class="form-group">
                <label>Date *</label>
                <input type="date" id="inventoryAdjustmentDate" required class="form-control">
            </div>
        </div>
        
        <div class="form-group">
            <label>Reason</label>
            <input type="text" id="inventoryAdjustmentReason" class="form-control" placeholder="e.g., Damaged goods, Found stock, etc.">
        </div>
        
        <div class="form-group">
            <label>Notes</label>
            <textarea id="inventoryAdjustmentNotes" class="form-control" rows="3" placeholder="Additional notes..."></textarea>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary" id="inventoryAdjustmentSubmitBtn">Add Adjustment</button>
            <button type="button" class="btn btn-secondary" onclick="clearInventoryAdjustmentForm()">Clear</button>
            <button type="button" class="btn btn-secondary" id="inventoryAdjustmentCancelBtn" onclick="clearInventoryAdjustmentForm()" style="display: none;">Cancel</button>
        </div>
    </form>
    
    <div id="inventoryAdjustmentMessage" style="margin-top: 20px;"></div>
    
    <h3 style="margin-top: 30px; margin-bottom: 15px; color: #1e3a5f;">Existing Adjustments</h3>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Item</th>
                    <th>Type</th>
                    <th>Quantity</th>
                    <th>Reason</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="inventoryAdjustmentsTableBody">
                <tr>
                    <td colspan="6" class="empty-state">Loading adjustments...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Physical Inventory Count Section -->
<div id="physicalCountSection" style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: none;">
    <h2 style="margin-bottom: 20px; color: #1e3a5f;">Physical Inventory Count</h2>
    <p style="color: #666; margin-bottom: 20px;">Upload a file with real item quantities counted on a specific date. The system will automatically adjust all inventory to match the real counts.</p>
    
    <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #1e3a5f;">
        <h3 style="margin-bottom: 15px; color: #1e3a5f; font-size: 18px;">üìã How It Works</h3>
        <ol style="color: #666; margin: 0; padding-left: 20px;">
            <li style="margin-bottom: 10px;">Upload an Excel file with columns: <strong>ItemCode</strong>, <strong>Quantity</strong> (real count), and <strong>Date</strong></li>
            <li style="margin-bottom: 10px;">The system calculates current inventory for each item (purchases - sales + adjustments)</li>
            <li style="margin-bottom: 10px;">For each item, it calculates the difference: Real Count - Current Inventory</li>
            <li style="margin-bottom: 10px;">Automatically creates <strong>Increase</strong> or <strong>Decrease</strong> adjustments to match the real count</li>
            <li>Items with no difference (within 0.01) will not be adjusted</li>
        </ol>
    </div>
    
    <form id="physicalCountForm" style="max-width: 600px; margin-bottom: 30px;">
        <h3 style="margin-bottom: 15px; color: #1e3a5f;">Upload Physical Count File</h3>
        <div class="form-group">
            <label>Excel File *</label>
            <input type="file" id="physicalCountFile" accept=".xlsx,.xls" required class="form-control">
            <small style="color: #666; display: block; margin-top: 5px;">
                Required columns: <strong>ItemCode</strong>, <strong>Quantity</strong>, <strong>Date</strong> (YYYY-MM-DD)
            </small>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary" id="physicalCountSubmitBtn">Process Physical Count</button>
            <button type="button" class="btn btn-secondary" onclick="clearPhysicalCountForm()">Clear</button>
        </div>
    </form>
    
    <div id="physicalCountMessage" style="margin-top: 20px;"></div>
    
    <div id="physicalCountResults" style="display: none; margin-top: 30px;">
        <h3 style="margin-bottom: 15px; color: #1e3a5f;">Processing Results</h3>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Item Code</th>
                        <th>Item Name</th>
                        <th>Current Inventory</th>
                        <th>Real Count</th>
                        <th>Difference</th>
                        <th>Adjustment Type</th>
                        <th>Adjustment Quantity</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="physicalCountResultsBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Other Settings Section -->
<div id="otherSettingsSection" style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: none;">
    <h2 style="margin-bottom: 20px; color: #1e3a5f;">‚öôÔ∏è Other Settings</h2>
    
    <!-- Calculation Method Settings -->
    <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #1e3a5f;">
        <h3 style="margin-bottom: 15px; color: #1e3a5f; font-size: 18px;">üìä Calculation Method Settings</h3>
        <p style="color: #666; margin-bottom: 15px;">Choose how inventory costs are calculated for all reports. This affects Profit/Loss, Stock Value, and all financial reports.</p>
        
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <label style="font-weight: 600; color: #1e3a5f;">Current Method:</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button id="calcMethodAverage" class="btn btn-primary" onclick="setCalculationMethod('Average')" style="padding: 10px 20px;">
                    üìà Average Cost
                </button>
                <button id="calcMethodFIFO" class="btn btn-secondary" onclick="setCalculationMethod('FIFO')" style="padding: 10px 20px;">
                    üîÑ FIFO (First In First Out)
                </button>
            </div>
            <span id="calcMethodStatus" style="color: #4caf50; font-weight: 600; margin-left: 10px;"></span>
        </div>
        
        <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 4px; font-size: 14px;">
            <strong>Average Cost:</strong> Uses average purchase price + average COG for all calculations.<br>
            <strong>FIFO:</strong> Uses actual cost of oldest inventory batches first. More accurate during price changes.
        </div>
        
        <div style="margin-top: 15px;">
            <button id="recalculateFIFOBtn" class="btn btn-warning" onclick="recalculateFIFOAllocations()" style="padding: 10px 20px; display: none;">
                üîÑ Recalculate FIFO Allocations
            </button>
            <p id="recalculateFIFOMessage" style="margin-top: 10px; color: #666; font-size: 13px;"></p>
        </div>
    </div>
    
</div>

<!-- Import Data Section (standalone) -->
<div id="importDataSection" style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: none;">
    <h2 style="margin-bottom: 20px; color: #1e3a5f;">üì• Import Data from Local Backup</h2>
    <p style="color: #666; margin-bottom: 20px;">Upload a data export file from your local app to load your markets, companies, items, sales, and more into this deployed instance.</p>
    <ol style="color: #666; margin-bottom: 20px; padding-left: 20px; line-height: 1.8;">
        <li>On your local computer, run: <code style="background:#e0e0e0;padding:2px 8px;border-radius:4px;">python scripts/export_data.py</code></li>
        <li>This creates <code style="background:#e0e0e0;padding:2px 8px;border-radius:4px;">data_export.json</code> in your project folder</li>
        <li>Upload that file below</li>
    </ol>
    <form id="importDataForm">
        <input type="file" id="importDataFile" accept=".json" required style="margin-bottom: 15px; display: block;">
        <button type="submit" class="btn btn-primary" id="importDataBtn">Import Data</button>
    </form>
    <p id="importDataMessage" style="margin-top: 15px; font-weight: 600;"></p>
</div>

<script>
let adjustments = [];

// Section navigation
function showSection(section) {
    // Hide all sections
    document.getElementById('safeAdjustmentsSection').style.display = 'none';
    document.getElementById('inventoryAdjustmentsSection').style.display = 'none';
    document.getElementById('physicalCountSection').style.display = 'none';
    document.getElementById('otherSettingsSection').style.display = 'none';
    document.getElementById('importDataSection').style.display = 'none';
    
    // Reset button styles
    document.getElementById('safeAdjustmentsBtn').className = 'btn btn-secondary';
    document.getElementById('inventoryAdjustmentsBtn').className = 'btn btn-secondary';
    document.getElementById('physicalCountBtn').className = 'btn btn-secondary';
    document.getElementById('importDataBtnTab').className = 'btn btn-secondary';
    document.getElementById('otherSettingsBtn').className = 'btn btn-secondary';
    
    // Show selected section
    if (section === 'safe') {
        document.getElementById('safeAdjustmentsSection').style.display = 'block';
        document.getElementById('safeAdjustmentsBtn').className = 'btn btn-primary';
    } else if (section === 'inventory') {
        document.getElementById('inventoryAdjustmentsSection').style.display = 'block';
        document.getElementById('inventoryAdjustmentsBtn').className = 'btn btn-primary';
    } else if (section === 'physical-count') {
        document.getElementById('physicalCountSection').style.display = 'block';
        document.getElementById('physicalCountBtn').className = 'btn btn-primary';
    } else if (section === 'import-data') {
        document.getElementById('importDataSection').style.display = 'block';
        document.getElementById('importDataBtnTab').className = 'btn btn-primary';
    } else if (section === 'other') {
        document.getElementById('otherSettingsSection').style.display = 'block';
        document.getElementById('otherSettingsBtn').className = 'btn btn-primary';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Load calculation method
    loadCalculationMethod();
    // Show safe adjustments by default
    showSection('safe');
    // Set default date to today
    document.getElementById('adjustmentDate').value = new Date().toISOString().split('T')[0];
    
    // Load market base currency
    fetch('/api/markets/current')
        .then(response => response.json())
        .then(data => {
            if (data.base_currency) {
                document.getElementById('adjustmentCurrency').value = data.base_currency;
            }
        })
        .catch(error => console.error('Error loading market:', error));
    
    // Form submission
    document.getElementById('adjustmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveAdjustment();
    });
    
    // Load existing adjustments
    loadAdjustments();
    
    // Physical Count form submission
    const physicalCountForm = document.getElementById('physicalCountForm');
    if (physicalCountForm) {
        physicalCountForm.addEventListener('submit', function(e) {
            e.preventDefault();
            processPhysicalCount();
        });
    }
    
    // Import Data form submission
    document.getElementById('importDataForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const fileInput = document.getElementById('importDataFile');
        if (!fileInput.files.length) return;
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(ev) {
            try {
                const data = JSON.parse(ev.target.result);
                document.getElementById('importDataBtn').disabled = true;
                document.getElementById('importDataMessage').textContent = 'Importing...';
                document.getElementById('importDataMessage').style.color = '#666';
                fetch('/api/import-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(r => r.json())
                .then(result => {
                    document.getElementById('importDataBtn').disabled = false;
                    if (result.error) {
                        document.getElementById('importDataMessage').textContent = 'Error: ' + result.error;
                        document.getElementById('importDataMessage').style.color = '#f44336';
                    } else {
                        document.getElementById('importDataMessage').textContent = 'Import successful! ' + (result.message || '');
                        document.getElementById('importDataMessage').style.color = '#4caf50';
                        fileInput.value = '';
                        setTimeout(() => location.reload(), 2000);
                    }
                })
                .catch(err => {
                    document.getElementById('importDataBtn').disabled = false;
                    document.getElementById('importDataMessage').textContent = 'Error: ' + err.message;
                    document.getElementById('importDataMessage').style.color = '#f44336';
                });
            } catch (err) {
                document.getElementById('importDataMessage').textContent = 'Invalid JSON file: ' + err.message;
                document.getElementById('importDataMessage').style.color = '#f44336';
            }
        };
        reader.readAsText(file);
    });
});

function saveAdjustment() {
    const adjustmentId = document.getElementById('adjustmentId').value;
    const data = {
        transaction_type: document.getElementById('adjustmentType').value,
        date: document.getElementById('adjustmentDate').value,
        amount: parseFloat(document.getElementById('adjustmentAmount').value),
        currency: document.getElementById('adjustmentCurrency').value,
        exchange_rate: parseFloat(document.getElementById('adjustmentExchangeRate').value) || 1,
        description: document.getElementById('adjustmentDescription').value
    };
    
    if (!data.transaction_type || !data.date || !data.amount || !data.currency || !data.description) {
        showMessage('Please fill in all required fields', 'error');
        return;
    }
    
    if (data.amount <= 0) {
        showMessage('Amount must be greater than zero', 'error');
        return;
    }
    
    const url = adjustmentId ? `/api/safe/adjustment/${adjustmentId}` : '/api/safe/adjustment';
    const method = adjustmentId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            showMessage('Error: ' + result.error, 'error');
        } else {
            const action = adjustmentId ? 'updated' : 'added';
            showMessage(`Adjustment ${action} successfully! Balance after: ${formatCurrency(result.balance_after)}`, 'success');
            clearAdjustmentForm();
            loadAdjustments();
        }
    })
    .catch(error => {
        console.error('Error saving adjustment:', error);
        showMessage('Error saving adjustment. Please try again.', 'error');
    });
}

function clearAdjustmentForm() {
    document.getElementById('adjustmentForm').reset();
    document.getElementById('adjustmentId').value = '';
    document.getElementById('adjustmentDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('adjustmentCurrency').value = 'CFA';
    document.getElementById('adjustmentExchangeRate').value = '1';
    document.getElementById('adjustmentFormTitle').textContent = 'Add New Adjustment';
    document.getElementById('adjustmentSubmitBtn').textContent = 'Add Adjustment';
    document.getElementById('adjustmentCancelBtn').style.display = 'none';
    document.getElementById('adjustmentMessage').innerHTML = '';
}

function loadAdjustments() {
    fetch('/api/safe/transactions')
        .then(response => response.json())
        .then(data => {
            // Filter to only show manual adjustments (no payment_id, sale_id, or general_expense_id)
            adjustments = data.filter(t => !t.payment_id && !t.sale_id && !t.general_expense_id);
            renderAdjustmentsTable();
        })
        .catch(error => {
            console.error('Error loading adjustments:', error);
            document.getElementById('adjustmentsTableBody').innerHTML = 
                '<tr><td colspan="7" class="empty-state">Error loading adjustments</td></tr>';
        });
}

function renderAdjustmentsTable() {
    const tbody = document.getElementById('adjustmentsTableBody');
    
    if (adjustments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No adjustments found</td></tr>';
        return;
    }
    
    tbody.innerHTML = adjustments.map(adj => {
        const typeColor = adj.transaction_type === 'Inflow' ? 'green' : 'red';
        return `
            <tr>
                <td>${formatDate(adj.date)}</td>
                <td><span style="color: ${typeColor}; font-weight: bold;">${adj.transaction_type}</span></td>
                <td>${adj.description || '-'}</td>
                <td class="currency">${formatCurrency(adj.amount)}</td>
                <td>${adj.currency}</td>
                <td class="currency">${formatCurrency(adj.balance_after)}</td>
                <td>
                    <button class="btn-icon btn-edit" onclick="editAdjustment(${adj.id})" title="Edit">‚úèÔ∏è</button>
                    <button class="btn-icon btn-delete" onclick="deleteAdjustment(${adj.id})" title="Delete">üóëÔ∏è</button>
                </td>
            </tr>
        `;
    }).join('');
}

function editAdjustment(id) {
    fetch(`/api/safe/adjustment/${id}`)
        .then(response => response.json())
        .then(adj => {
            if (adj.error) {
                showMessage('Error: ' + adj.error, 'error');
                return;
            }
            
            document.getElementById('adjustmentId').value = adj.id;
            document.getElementById('adjustmentType').value = adj.transaction_type;
            document.getElementById('adjustmentDate').value = adj.date;
            document.getElementById('adjustmentAmount').value = adj.amount;
            document.getElementById('adjustmentCurrency').value = adj.currency;
            document.getElementById('adjustmentExchangeRate').value = adj.exchange_rate;
            document.getElementById('adjustmentDescription').value = adj.description;
            document.getElementById('adjustmentFormTitle').textContent = 'Edit Adjustment';
            document.getElementById('adjustmentSubmitBtn').textContent = 'Update Adjustment';
            document.getElementById('adjustmentCancelBtn').style.display = 'inline-block';
            
            // Scroll to form
            document.getElementById('adjustmentForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        })
        .catch(error => {
            console.error('Error loading adjustment:', error);
            showMessage('Error loading adjustment. Please try again.', 'error');
        });
}

function deleteAdjustment(id) {
    if (!confirm('Are you sure you want to delete this adjustment? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/safe/adjustment/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            showMessage('Error: ' + result.error, 'error');
        } else {
            showMessage('Adjustment deleted successfully!', 'success');
            loadAdjustments();
        }
    })
    .catch(error => {
        console.error('Error deleting adjustment:', error);
        showMessage('Error deleting adjustment. Please try again.', 'error');
    });
}

function formatDate(dateStr) {
    const date = new Date(dateStr + 'T00:00:00');
    return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function showMessage(message, type) {
    const messageDiv = document.getElementById('adjustmentMessage');
    const color = type === 'success' ? '#4caf50' : '#f44336';
    messageDiv.innerHTML = `<div style="padding: 10px; background: ${color === '#4caf50' ? '#e8f5e9' : '#ffebee'}; color: ${color}; border-radius: 4px; border-left: 4px solid ${color};">
        ${message}
    </div>`;
    
    if (type === 'success') {
        setTimeout(() => {
            messageDiv.innerHTML = '';
        }, 5000);
    }
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount);
}

function formatNumber(num) {
    if (num === null || num === undefined) return 'N/A';
    return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(num);
}

// Inventory Adjustments
let inventoryAdjustments = [];

// Load items and adjustments when DOM is ready (if not already loaded)
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initInventoryAdjustments);
} else {
    initInventoryAdjustments();
}

function initInventoryAdjustments() {
    // Set default date to today for inventory adjustment
    const dateInput = document.getElementById('inventoryAdjustmentDate');
    if (dateInput) {
        dateInput.value = new Date().toISOString().split('T')[0];
    }
    
    // Load items for inventory adjustment dropdown
    loadItemsForInventoryAdjustment();
    
    // Form submission
    const form = document.getElementById('inventoryAdjustmentForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            saveInventoryAdjustment();
        });
    }
    
    // Load existing inventory adjustments
    loadInventoryAdjustments();
}

function loadItemsForInventoryAdjustment() {
    fetch('/api/items')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('inventoryAdjustmentItem');
            if (select) {
                select.innerHTML = '<option value="">Select Item</option>';
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.code} - ${item.name}`;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error loading items:', error));
}

function saveInventoryAdjustment() {
    const adjustmentId = document.getElementById('inventoryAdjustmentId').value;
    const data = {
        item_id: parseInt(document.getElementById('inventoryAdjustmentItem').value),
        adjustment_type: document.getElementById('inventoryAdjustmentType').value,
        quantity: parseFloat(document.getElementById('inventoryAdjustmentQuantity').value),
        date: document.getElementById('inventoryAdjustmentDate').value,
        reason: document.getElementById('inventoryAdjustmentReason').value,
        notes: document.getElementById('inventoryAdjustmentNotes').value
    };
    
    if (!data.item_id || !data.adjustment_type || !data.quantity || !data.date) {
        showInventoryAdjustmentMessage('Please fill in all required fields', 'error');
        return;
    }
    
    if (data.quantity <= 0) {
        showInventoryAdjustmentMessage('Quantity must be greater than zero', 'error');
        return;
    }
    
    const url = adjustmentId ? `/api/inventory/adjustments/${adjustmentId}` : '/api/inventory/adjustments';
    const method = adjustmentId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            showInventoryAdjustmentMessage('Error: ' + result.error, 'error');
        } else {
            const action = adjustmentId ? 'updated' : 'added';
            showInventoryAdjustmentMessage(`Inventory adjustment ${action} successfully!`, 'success');
            clearInventoryAdjustmentForm();
            loadInventoryAdjustments();
        }
    })
    .catch(error => {
        console.error('Error saving inventory adjustment:', error);
        showInventoryAdjustmentMessage('Error saving adjustment. Please try again.', 'error');
    });
}

function clearInventoryAdjustmentForm() {
    document.getElementById('inventoryAdjustmentForm').reset();
    document.getElementById('inventoryAdjustmentId').value = '';
    const dateInput = document.getElementById('inventoryAdjustmentDate');
    if (dateInput) {
        dateInput.value = new Date().toISOString().split('T')[0];
    }
    document.getElementById('inventoryAdjustmentFormTitle').textContent = 'Add New Adjustment';
    document.getElementById('inventoryAdjustmentSubmitBtn').textContent = 'Add Adjustment';
    document.getElementById('inventoryAdjustmentCancelBtn').style.display = 'none';
    document.getElementById('inventoryAdjustmentMessage').innerHTML = '';
}

function loadInventoryAdjustments() {
    fetch('/api/inventory/adjustments')
        .then(response => response.json())
        .then(data => {
            inventoryAdjustments = data;
            renderInventoryAdjustmentsTable();
        })
        .catch(error => {
            console.error('Error loading inventory adjustments:', error);
            const tbody = document.getElementById('inventoryAdjustmentsTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Error loading adjustments</td></tr>';
            }
        });
}

function renderInventoryAdjustmentsTable() {
    const tbody = document.getElementById('inventoryAdjustmentsTableBody');
    if (!tbody) return;
    
    if (inventoryAdjustments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No adjustments found</td></tr>';
        return;
    }
    
    tbody.innerHTML = inventoryAdjustments.map(adj => {
        const typeColor = adj.adjustment_type === 'Increase' ? '#4caf50' : '#f44336';
        const typeSymbol = adj.adjustment_type === 'Increase' ? '+' : '-';
        return `
            <tr>
                <td>${formatDate(adj.date)}</td>
                <td>${adj.item_code} - ${adj.item_name}</td>
                <td><span style="color: ${typeColor}; font-weight: bold;">${adj.adjustment_type}</span></td>
                <td><strong>${typeSymbol}${adj.quantity.toFixed(2)}</strong></td>
                <td>${adj.reason || '-'}</td>
                <td>
                    <button class="btn-icon btn-edit" onclick="editInventoryAdjustment(${adj.id})" title="Edit">‚úèÔ∏è</button>
                    <button class="btn-icon btn-delete" onclick="deleteInventoryAdjustment(${adj.id})" title="Delete">üóëÔ∏è</button>
                </td>
            </tr>
        `;
    }).join('');
}

function editInventoryAdjustment(id) {
    fetch(`/api/inventory/adjustments/${id}`)
        .then(response => response.json())
        .then(adj => {
            if (adj.error) {
                showInventoryAdjustmentMessage('Error: ' + adj.error, 'error');
                return;
            }
            
            document.getElementById('inventoryAdjustmentId').value = adj.id;
            document.getElementById('inventoryAdjustmentItem').value = adj.item_id;
            document.getElementById('inventoryAdjustmentType').value = adj.adjustment_type;
            document.getElementById('inventoryAdjustmentQuantity').value = adj.quantity;
            document.getElementById('inventoryAdjustmentDate').value = adj.date;
            document.getElementById('inventoryAdjustmentReason').value = adj.reason || '';
            document.getElementById('inventoryAdjustmentNotes').value = adj.notes || '';
            document.getElementById('inventoryAdjustmentFormTitle').textContent = 'Edit Adjustment';
            document.getElementById('inventoryAdjustmentSubmitBtn').textContent = 'Update Adjustment';
            document.getElementById('inventoryAdjustmentCancelBtn').style.display = 'inline-block';
            
            // Scroll to form
            document.getElementById('inventoryAdjustmentForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        })
        .catch(error => {
            console.error('Error loading inventory adjustment:', error);
            showInventoryAdjustmentMessage('Error loading adjustment. Please try again.', 'error');
        });
}

function deleteInventoryAdjustment(id) {
    if (!confirm('Are you sure you want to delete this inventory adjustment? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/inventory/adjustments/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            showInventoryAdjustmentMessage('Error: ' + result.error, 'error');
        } else {
            showInventoryAdjustmentMessage('Adjustment deleted successfully!', 'success');
            loadInventoryAdjustments();
        }
    })
    .catch(error => {
        console.error('Error deleting inventory adjustment:', error);
        showInventoryAdjustmentMessage('Error deleting adjustment. Please try again.', 'error');
    });
}

function showInventoryAdjustmentMessage(message, type) {
    const messageDiv = document.getElementById('inventoryAdjustmentMessage');
    if (!messageDiv) return;
    const color = type === 'success' ? '#4caf50' : '#f44336';
    messageDiv.innerHTML = `<div style="padding: 10px; background: ${color === '#4caf50' ? '#e8f5e9' : '#ffebee'}; color: ${color}; border-radius: 4px; border-left: 4px solid ${color};">
        ${message}
    </div>`;
    
    if (type === 'success') {
        setTimeout(() => {
            messageDiv.innerHTML = '';
        }, 5000);
    }
}

// Import Modal for Inventory Adjustments
function openInventoryImportModal() {
    let modal = document.getElementById('inventoryImportModal');
    if (!modal) {
        // Create modal if it doesn't exist
        const modalHTML = `
            <div id="inventoryImportModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 600px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #1e3a5f; margin: 0;">Import Inventory Adjustments from Excel</h3>
                        <button onclick="closeInventoryImportModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <p style="color: #666; margin-bottom: 15px;">Upload an Excel file with the following columns:</p>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                            <strong>Required columns:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li><strong>ItemCode</strong> (or Item ID) - Item code or ID</li>
                                <li><strong>AdjustmentType</strong> - "Increase" or "Decrease"</li>
                                <li><strong>Quantity</strong> - Quantity to adjust (must be > 0)</li>
                                <li><strong>Date</strong> - Date in YYYY-MM-DD format</li>
                            </ul>
                            <strong>Optional columns:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li><strong>Reason</strong> - Reason for adjustment</li>
                                <li><strong>Notes</strong> - Additional notes</li>
                            </ul>
                        </div>
                        <input type="file" id="inventoryImportFile" accept=".xlsx,.xls" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div id="inventoryImportMessage" style="margin-bottom: 15px;"></div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeInventoryImportModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="importInventoryAdjustments()">Import</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modal = document.getElementById('inventoryImportModal');
    }
    modal.style.display = 'block';
    document.getElementById('inventoryImportFile').value = '';
    document.getElementById('inventoryImportMessage').innerHTML = '';
}

function closeInventoryImportModal() {
    const modal = document.getElementById('inventoryImportModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function importInventoryAdjustments() {
    const fileInput = document.getElementById('inventoryImportFile');
    const file = fileInput.files[0];
    const messageDiv = document.getElementById('inventoryImportMessage');
    
    if (!file) {
        messageDiv.innerHTML = '<div style="padding: 10px; background: #ffebee; color: #f44336; border-radius: 4px;">Please select a file</div>';
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    messageDiv.innerHTML = '<div style="padding: 10px; background: #e3f2fd; color: #1976d2; border-radius: 4px;">Uploading and processing file...</div>';
    
    fetch('/api/inventory/adjustments/import', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            messageDiv.innerHTML = `<div style="padding: 10px; background: #ffebee; color: #f44336; border-radius: 4px;">Error: ${result.error}</div>`;
        } else {
            let message = `<div style="padding: 10px; background: #e8f5e9; color: #4caf50; border-radius: 4px;">
                <strong>Import completed!</strong><br>
                Successfully imported: ${result.imported} adjustment(s)`;
            
            if (result.errors && result.errors.length > 0) {
                message += `<br>Errors: ${result.errors.length}`;
                message += `<div style="margin-top: 10px; max-height: 200px; overflow-y: auto; background: white; padding: 10px; border-radius: 4px; font-size: 12px;">`;
                result.errors.forEach(error => {
                    message += `<div style="color: #f44336; margin-bottom: 5px;">${error}</div>`;
                });
                message += `</div>`;
            }
            
            message += `</div>`;
            messageDiv.innerHTML = message;
            
            if (result.imported > 0) {
                // Reload adjustments after a short delay
                setTimeout(() => {
                    loadInventoryAdjustments();
                    setTimeout(() => {
                        closeInventoryImportModal();
                    }, 2000);
                }, 1000);
            }
        }
    })
    .catch(error => {
        console.error('Error importing adjustments:', error);
        messageDiv.innerHTML = `<div style="padding: 10px; background: #ffebee; color: #f44336; border-radius: 4px;">Error importing file. Please try again.</div>`;
    });
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('inventoryImportModal');
    if (event.target == modal) {
        closeInventoryImportModal();
    }
}

// Calculation Method Functions
let currentCalculationMethod = 'Average';

function loadCalculationMethod() {
    fetch('/api/markets/calculation-method')
        .then(response => response.json())
        .then(data => {
            if (data.method) {
                currentCalculationMethod = data.method;
                updateCalculationMethodUI(data.method);
            }
        })
        .catch(error => {
            console.error('Error loading calculation method:', error);
        });
}

function setCalculationMethod(method) {
    if (method === currentCalculationMethod) {
        return; // Already set
    }
    
    if (!confirm(`Are you sure you want to switch to ${method} calculation method? This will affect all reports.`)) {
        return;
    }
    
    fetch('/api/markets/calculation-method', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ method: method })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || `HTTP error! status: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            currentCalculationMethod = method;
            updateCalculationMethodUI(method);
            let message = `Calculation method changed to ${method} successfully!`;
            if (data.warning) {
                message += '\n\nWarning: ' + data.warning;
            } else if (data.message) {
                message += '\n\n' + data.message;
            }
            showCalculationMethodMessage(message, data.warning ? 'warning' : 'success');
            // Update the indicator in the header
            if (typeof loadCalculationMethodIndicator === 'function') {
                loadCalculationMethodIndicator();
            }
        }
    })
    .catch(error => {
        console.error('Error setting calculation method:', error);
        alert('Error updating calculation method: ' + error.message);
    });
}

function updateCalculationMethodUI(method) {
    const avgBtn = document.getElementById('calcMethodAverage');
    const fifoBtn = document.getElementById('calcMethodFIFO');
    const statusSpan = document.getElementById('calcMethodStatus');
    
    // Show/hide recalculate button based on method
    const recalculateBtn = document.getElementById('recalculateFIFOBtn');
    if (recalculateBtn) {
        recalculateBtn.style.display = method === 'FIFO' ? 'inline-block' : 'none';
    }
    
    if (method === 'Average') {
        avgBtn.className = 'btn btn-primary';
        fifoBtn.className = 'btn btn-secondary';
        statusSpan.textContent = '‚úì Using Average Cost Method';
    } else {
        avgBtn.className = 'btn btn-secondary';
        fifoBtn.className = 'btn btn-primary';
        statusSpan.textContent = '‚úì Using FIFO Method';
    }
}

function recalculateFIFOAllocations() {
    if (!confirm('This will recalculate all FIFO allocations with the correct exchange rate formula. This may take a few moments. Continue?')) {
        return;
    }
    
    const messageEl = document.getElementById('recalculateFIFOMessage');
    const btn = document.getElementById('recalculateFIFOBtn');
    
    if (messageEl) messageEl.textContent = 'Recalculating...';
    if (btn) btn.disabled = true;
    
    fetch('/api/markets/recalculate-fifo-allocations', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (messageEl) {
                messageEl.textContent = data.message || 'Allocations recalculated successfully! Please refresh your reports page to see the updated values.';
                messageEl.style.color = '#4caf50';
            }
            showCalculationMethodMessage((data.message || 'Allocations recalculated successfully!') + ' Please refresh your reports page to see the updated values.', 'success');
        } else {
            if (messageEl) {
                messageEl.textContent = data.error || 'Error recalculating allocations';
                messageEl.style.color = '#f44336';
            }
            alert('Error: ' + (data.error || 'Failed to recalculate allocations'));
        }
    })
    .catch(error => {
        console.error('Error recalculating allocations:', error);
        if (messageEl) {
            messageEl.textContent = 'Error: ' + error.message;
            messageEl.style.color = '#f44336';
        }
        alert('Error recalculating allocations: ' + error.message);
    })
    .finally(() => {
        if (btn) btn.disabled = false;
    });
}

function showCalculationMethodMessage(message, type) {
    // Create a temporary message div
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = `position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: ${type === 'success' ? '#e8f5e9' : '#ffebee'}; color: ${type === 'success' ? '#4caf50' : '#f44336'}; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000;`;
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}

// Physical Inventory Count Functions
function processPhysicalCount() {
    const fileInput = document.getElementById('physicalCountFile');
    const file = fileInput?.files[0];
    const messageDiv = document.getElementById('physicalCountMessage');
    const resultsDiv = document.getElementById('physicalCountResults');
    const resultsBody = document.getElementById('physicalCountResultsBody');
    const submitBtn = document.getElementById('physicalCountSubmitBtn');
    
    if (!file) {
        showPhysicalCountMessage('Please select an Excel file to upload', 'error');
        return;
    }
    
    if (!confirm('This will automatically adjust inventory for all items in the file. Continue?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';
    messageDiv.innerHTML = '<div style="padding: 10px; background: #e3f2fd; color: #1976d2; border-radius: 4px;">Processing physical count file...</div>';
    resultsDiv.style.display = 'none';
    
    fetch('/api/inventory/adjustments/physical-count', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Process Physical Count';
        
        if (result.error) {
            showPhysicalCountMessage('Error: ' + result.error, 'error');
            return;
        }
        
        if (!result.success) {
            showPhysicalCountMessage('Error processing file', 'error');
            return;
        }
        
        // Show success message
        let message = `<div style="padding: 15px; background: #e8f5e9; color: #4caf50; border-radius: 4px; border-left: 4px solid #4caf50;">
            <strong>Physical count processed successfully!</strong><br>
            Items processed: ${result.items_processed}<br>
            Adjustments created: ${result.adjustments_created}`;
        
        if (result.errors && result.errors.length > 0) {
            message += `<br>Errors: ${result.errors.length}`;
        }
        message += `</div>`;
        
        messageDiv.innerHTML = message;
        
        // Show results table
        if (result.results && result.results.length > 0) {
            resultsBody.innerHTML = result.results.map(item => {
                const diffColor = Math.abs(item.difference) < 0.01 ? '#666' : (item.difference > 0 ? '#4caf50' : '#f44336');
                const statusColor = item.status === 'Adjusted' ? '#4caf50' : '#666';
                const adjTypeColor = item.adjustment_type === 'Increase' ? '#4caf50' : (item.adjustment_type === 'Decrease' ? '#f44336' : '#666');
                
                return `
                    <tr>
                        <td>${escapeHtml(item.item_code)}</td>
                        <td>${escapeHtml(item.item_name)}</td>
                        <td style="text-align: right;">${formatNumber(item.current_inventory)}</td>
                        <td style="text-align: right;">${formatNumber(item.real_count)}</td>
                        <td style="text-align: right; color: ${diffColor}; font-weight: bold;">${item.difference >= 0 ? '+' : ''}${formatNumber(item.difference)}</td>
                        <td style="color: ${adjTypeColor}; font-weight: bold;">${item.adjustment_type || '-'}</td>
                        <td style="text-align: right;">${item.adjustment_quantity > 0 ? formatNumber(item.adjustment_quantity) : '-'}</td>
                        <td style="color: ${statusColor}; font-weight: bold;">${item.status}</td>
                    </tr>
                `;
            }).join('');
            
            resultsDiv.style.display = 'block';
        }
        
        // Show errors if any
        if (result.errors && result.errors.length > 0) {
            let errorsHtml = '<div style="margin-top: 15px; padding: 15px; background: #fff3cd; color: #856404; border-radius: 4px; border-left: 4px solid #ffc107;">';
            errorsHtml += '<strong>Errors/Warnings:</strong><ul style="margin: 10px 0; padding-left: 20px;">';
            result.errors.forEach(error => {
                errorsHtml += `<li style="margin-bottom: 5px;">${escapeHtml(error)}</li>`;
            });
            errorsHtml += '</ul></div>';
            messageDiv.innerHTML += errorsHtml;
        }
        
        // Reload inventory adjustments after a delay
        if (result.adjustments_created > 0) {
            setTimeout(() => {
                loadInventoryAdjustments();
            }, 2000);
        }
    })
    .catch(error => {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Process Physical Count';
        console.error('Error processing physical count:', error);
        showPhysicalCountMessage('Error processing file: ' + error.message, 'error');
    });
}

function clearPhysicalCountForm() {
    document.getElementById('physicalCountForm').reset();
    document.getElementById('physicalCountMessage').innerHTML = '';
    document.getElementById('physicalCountResults').style.display = 'none';
}

function showPhysicalCountMessage(message, type) {
    const messageDiv = document.getElementById('physicalCountMessage');
    const color = type === 'success' ? '#4caf50' : '#f44336';
    messageDiv.innerHTML = `<div style="padding: 10px; background: ${color === '#4caf50' ? '#e8f5e9' : '#ffebee'}; color: ${color}; border-radius: 4px; border-left: 4px solid ${color};">
        ${message}
    </div>`;
    
    if (type === 'success') {
        setTimeout(() => {
            // Keep success message visible longer
        }, 10000);
    }
}

function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}

